<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯ç¾å‘³é¤å…</title>
    <style>
        :root {
            --primary: #ff6b6b;  /* ä¸»è‰²è°ƒï¼šæš–çº¢ */
            --accent: #4ecdc4;   /* è¾…åŠ©è‰²ï¼šé’ç»¿ */
            --dark: #2d3436;     /* æ·±è‰²æ–‡æœ¬ */
            --gray: #f7f9fc;     /* èƒŒæ™¯ç° */
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body { 
            font-family: -apple-system, "Helvetica Neue", sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--gray); 
            color: var(--dark); 
            -webkit-tap-highlight-color: transparent;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header { 
            background: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            position: sticky; top: 0; z-index: 100;
        }
        h1 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; }
        .store-badge { 
            background: var(--accent); color: white; 
            padding: 3px 8px; border-radius: 8px; 
            font-size: 0.7rem; margin-left: 8px; 
        }

        /* å®¹å™¨ */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }

        /* åˆ†ç±»æ  */
        .category-nav { 
            display: flex; gap: 10px; overflow-x: auto; 
            padding-bottom: 10px; margin-bottom: 15px; 
            scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ */
        }
        .category-nav::-webkit-scrollbar { display: none; }
        .cat-btn { 
            background: white; border: 1px solid #eee; 
            padding: 8px 16px; border-radius: 20px; 
            white-space: nowrap; cursor: pointer; color: #666;
            transition: all 0.2s;
        }
        .cat-btn.active { 
            background: var(--dark); color: white; 
            border-color: var(--dark); font-weight: bold; 
        }

        /* èœå•åˆ—è¡¨ */
        .menu-list { display: flex; flex-direction: column; gap: 15px; }
        .menu-item { 
            background: white; border-radius: 16px; padding: 12px; 
            display: flex; gap: 15px; box-shadow: var(--shadow); 
            align-items: center;
        }
        .item-img { 
            width: 80px; height: 80px; border-radius: 12px; 
            object-fit: cover; background-color: #eee; 
        }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
        .item-desc { font-size: 0.8rem; color: #888; margin-bottom: 8px; line-height: 1.2;}
        .item-price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        
        .add-btn { 
            width: 30px; height: 30px; border-radius: 50%; 
            border: none; background: var(--primary); color: white; 
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; 
        }
        .add-btn:active { transform: scale(0.9); }

        /* æ‚¬æµ®è´­ç‰©è½¦ */
        .float-cart { 
            position: fixed; bottom: 20px; left: 5%; width: 90%; max-width: 580px;
            background: var(--dark); color: white; 
            border-radius: 50px; height: 60px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 900;
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .float-cart.show { transform: translateY(0); }
        .cart-info { display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        .total-price { font-size: 1.2rem; font-weight: bold; }
        .checkout-btn { 
            background: var(--primary); color: white; border: none; 
            padding: 10px 20px; border-radius: 30px; 
            font-weight: bold; cursor: pointer; 
        }

        /* è´­ç‰©è½¦è¯¦æƒ…å¼¹çª— */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 800; display: none; 
            flex-direction: column; justify-content: flex-end; 
        }
        .modal-content { 
            background: white; border-radius: 24px 24px 0 0; padding: 25px; 
            animation: slideUp 0.3s; max-height: 70vh; overflow-y: auto;
        }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        
        .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #ddd; background: white; display:flex; align-items:center; justify-content:center; cursor:pointer;}
        
        /* è¾“å…¥æ¡†ç¾åŒ– */
        input[type="text"] { 
            width: 100%; padding: 15px; margin-top: 10px; 
            border: 1px solid #eee; border-radius: 12px; 
            font-size: 1rem; box-sizing: border-box; background: #f9f9f9;
        }
        input[type="text"]:focus { outline: 2px solid var(--accent); background: white; }

        /* è½»æç¤º Toast */
        #toast { 
            visibility: hidden; min-width: 200px; 
            background-color: rgba(0,0,0,0.8); color: #fff; 
            text-align: center; border-radius: 50px; padding: 12px 20px; 
            position: fixed; z-index: 1000; left: 50%; bottom: 100px; 
            transform: translateX(-50%); opacity: 0; transition: all 0.3s; 
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }

        /* åå°æŠ¥è¡¨å¼¹çª— */
        .admin-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; }
        .admin-box { background:white; width:80%; max-width:400px; padding:20px; border-radius:16px; text-align:center; }
        .report-item { background:#f8f9fa; margin:10px 0; padding:15px; border-radius:8px; display:flex; justify-content:space-between; }
    </style>
</head>
<body>

    <header>
        <h1>ç¾å‘³é¤å… <span id="store-id-display" class="store-badge">1å·åº—</span></h1>
        <button onclick="openAdmin()" style="border:none; background:transparent; font-size:1.2rem; cursor:pointer;">ğŸ“Š</button>
    </header>

    <div class="container">
        <div class="category-nav">
            <button class="cat-btn active" onclick="renderMenu('all')">å…¨éƒ¨</button>
            <button class="cat-btn" onclick="renderMenu('hot')">ğŸ”¥ çƒ­é”€æ¨è</button>
            <button class="cat-btn" onclick="renderMenu('main')">ğŸœ ä¸»é£Ÿé¢ç‚¹</button>
            <button class="cat-btn" onclick="renderMenu('drink')">ğŸ¥¤ æ¸…å‡‰é¥®æ–™</button>
        </div>

        <div id="menu-container" class="menu-list"></div>
    </div>

    <div id="float-cart" class="float-cart" onclick="toggleCartModal()">
        <div class="cart-info">
            <span style="font-size:1.5rem;">ğŸ›’</span>
            <span id="cart-count" class="badge">0</span>
            <span id="cart-total" class="total-price">Â¥0.00</span>
        </div>
        <button class="checkout-btn" onclick="event.stopPropagation(); prepareCheckout()">å»ç»“ç®—</button>
    </div>

    <div id="cart-modal" class="modal-overlay" onclick="if(event.target===this) toggleCartModal()">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>å·²é€‰é¤ç‚¹</h2>
                <span onclick="clearCart()" style="color:#999; cursor:pointer; font-size:0.9rem;">æ¸…ç©º</span>
            </div>
            
            <div id="cart-items-list"></div>

            <div style="margin-top:20px; border-top:1px dashed #eee; padding-top:20px;">
                <label style="font-weight:bold; color:#555;">æ‚¨çš„æ¡Œå· / å–é¤å·:</label>
                <input type="text" id="table-num" placeholder="ä¾‹å¦‚: A01">
            </div>

            <button onclick="submitOrder()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:12px; font-size:1.1rem; font-weight:bold; margin-top:20px;">ç¡®è®¤ä¸‹å•</button>
        </div>
    </div>

    <div id="toast">å·²åŠ å…¥è´­ç‰©è½¦</div>

    <div id="admin-modal" class="admin-modal">
        <div class="admin-box">
            <h3>ğŸ“… ä»Šæ—¥è¥æ”¶æŠ¥è¡¨</h3>
            <div id="report-content" style="text-align:left;">åŠ è½½ä¸­...</div>
            <button onclick="document.getElementById('admin-modal').style.display='none'" style="margin-top:15px; padding:8px 30px; border:1px solid #ddd; background:white; border-radius:20px;">å…³é—­</button>
        </div>
    </div>

<script>
    // --- 1. é…ç½®æ•°æ® ---
    // è‡ªåŠ¨è·å– URL ä¸­çš„ ?store=Xï¼Œé»˜è®¤ä¸º 1
    const urlParams = new URLSearchParams(window.location.search);
    const storeId = urlParams.get('store') || '1';
    document.getElementById('store-id-display').innerText = `${storeId}å·åº—`;

    // èœå•æ•°æ® (ä¸ºäº†æ¼”ç¤ºç¾è§‚ï¼Œä½¿ç”¨äº†å ä½å›¾ï¼Œæ­£å¼ä½¿ç”¨å¯æ¢æˆæ‚¨è‡ªå·±çš„å›¾ç‰‡URL)
    const menu = [
        { id: 1, name: "æ‹›ç‰Œçº¢çƒ§è‚‰", price: 48.00, cat: "hot", desc: "è‚¥è€Œä¸è…»ï¼Œå…¥å£å³åŒ–ï¼Œæ¯æ—¥é™é‡", img: "https://images.unsplash.com/photo-1606728035253-49e8a23146de?auto=format&fit=crop&w=100&q=80" },
        { id: 2, name: "é¦™è¾£å£æ°´é¸¡", price: 38.00, cat: "hot", desc: "é›†éº»è¾£é²œé¦™å«©çˆ½äºä¸€èº«", img: "https://images.unsplash.com/photo-1626804475297-411dbe6314f3?auto=format&fit=crop&w=100&q=80" },
        { id: 3, name: "æå“ç‰›è‚‰é¢", price: 32.00, cat: "main", desc: "æ…¢ç‚–ç‰›è…©ï¼Œæ±¤æµ“è‚‰çƒ‚", img: "https://images.unsplash.com/photo-1554502078-ef0fc409efce?auto=format&fit=crop&w=100&q=80" },
        { id: 4, name: "æ‰¬å·ç‚’é¥­", price: 28.00, cat: "main", desc: "ç²’ç²’åˆ†æ˜ï¼Œé…æ–™ä¸°å¯Œ", img: "https://images.unsplash.com/photo-1603133872878-684f5c936fdb?auto=format&fit=crop&w=100&q=80" },
        { id: 5, name: "å†°é•‡é…¸æ¢…æ±¤", price: 10.00, cat: "drink", desc: "è‡ªå®¶ç†¬åˆ¶ï¼Œè§£æš‘ç¥å™¨", img: "https://images.unsplash.com/photo-1606272522736-1d70d2215c2a?auto=format&fit=crop&w=100&q=80" },
        { id: 6, name: "å¯å£å¯ä¹", price: 5.00, cat: "drink", desc: "å¿«ä¹è‚¥å®…æ°´", img: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=100&q=80" }
    ];

    let cart = [];

    // --- 2. æ ¸å¿ƒé€»è¾‘ ---
    
    // åˆå§‹åŒ–
    function init() {
        // ä» LocalStorage æ¢å¤è´­ç‰©è½¦ (é˜²æ­¢åˆ·æ–°ä¸¢å¤±)
        const saved = localStorage.getItem(`cart_store_${storeId}`);
        if(saved) {
            cart = JSON.parse(saved);
            updateCartUI();
        }
        renderMenu('all');
    }

    // æ¸²æŸ“èœå•
    function renderMenu(category) {
        const container = document.getElementById('menu-container');
        container.innerHTML = '';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(event) event.target.classList.add('active');
        else document.querySelector('.cat-btn').classList.add('active'); // é»˜è®¤å…¨éƒ¨é«˜äº®

        menu.forEach(item => {
            if (category === 'all' || item.cat === category) {
                container.innerHTML += `
                    <div class="menu-item">
                        <img src="${item.img}" class="item-img" alt="${item.name}">
                        <div class="item-info">
                            <div class="item-title">${item.name}</div>
                            <div class="item-desc">${item.desc}</div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="item-price">Â¥${item.price.toFixed(2)}</span>
                                <button class="add-btn" onclick="addToCart(${item.id})">ï¼‹</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
    }

    // æ·»åŠ è´­ç‰©è½¦
    function addToCart(id) {
        const item = menu.find(i => i.id === id);
        const exist = cart.find(i => i.id === id);
        if(exist) exist.quantity++;
        else cart.push({...item, quantity: 1});
        
        showToast(`å·²æ·»åŠ : ${item.name}`);
        saveAndUpdate();
    }

    // ä¿®æ”¹æ•°é‡
    function changeQty(id, delta) {
        const index = cart.findIndex(i => i.id === id);
        if(index > -1) {
            cart[index].quantity += delta;
            if(cart[index].quantity <= 0) cart.splice(index, 1);
            saveAndUpdate();
            renderCartList(); // åˆ·æ–°å¼¹çª—åˆ—è¡¨
            
            // å¦‚æœç©ºäº†ï¼Œè‡ªåŠ¨å…³é—­å¼¹çª—
            if(cart.length === 0) toggleCartModal();
        }
    }

    // ä¿å­˜å¹¶æ›´æ–°ç•Œé¢
    function saveAndUpdate() {
        localStorage.setItem(`cart_store_${storeId}`, JSON.stringify(cart));
        updateCartUI();
    }

    function updateCartUI() {
        const count = cart.reduce((acc, i) => acc + i.quantity, 0);
        const total = cart.reduce((acc, i) => acc + (i.price * i.quantity), 0);
        
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-total').innerText = 'Â¥' + total.toFixed(2);
        
        const bar = document.getElementById('float-cart');
        if(count > 0) bar.classList.add('show');
        else bar.classList.remove('show');
    }

    // å¼¹çª—æ§åˆ¶
    function toggleCartModal() {
        const modal = document.getElementById('cart-modal');
        if(modal.style.display === 'flex') {
            modal.style.display = 'none';
        } else if (cart.length > 0) {
            renderCartList();
            modal.style.display = 'flex';
        }
    }

    function renderCartList() {
        const list = document.getElementById('cart-items-list');
        list.innerHTML = '';
        cart.forEach(item => {
            list.innerHTML += `
                <div class="cart-row">
                    <div>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="color:#888; font-size:0.9rem;">Â¥${item.price}</div>
                    </div>
                    <div class="qty-ctrl">
                        <button class="qty-btn" onclick="changeQty(${item.id}, -1)">-</button>
                        <span style="width:20px; text-align:center;">${item.quantity}</span>
                        <button class="qty-btn" onclick="changeQty(${item.id}, 1)">+</button>
                    </div>
                </div>
            `;
        });
    }

    function clearCart() {
        if(confirm('ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
            cart = [];
            saveAndUpdate();
            toggleCartModal();
        }
    }

    function prepareCheckout() {
        toggleCartModal();
        // è‡ªåŠ¨èšç„¦
        setTimeout(() => document.getElementById('table-num').focus(), 100);
    }

    // æ˜¾ç¤ºè½»æç¤º
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = 'show';
        setTimeout(() => t.className = '', 2500);
    }

    // --- 3. æäº¤è®¢å•åˆ°åç«¯ ---
    async function submitOrder() {
        const table = document.getElementById('table-num').value.trim();
        if(!table) {
            showToast('âš ï¸ è¯·å¡«å†™æ¡Œå·');
            return;
        }

        const total = cart.reduce((acc, i) => acc + (i.price * i.quantity), 0);
        showToast('â³ è®¢å•æäº¤ä¸­...');

        try {
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    storeId: storeId,
                    tableNumber: table,
                    items: cart,
                    totalPrice: total
                })
            });

            const data = await res.json();
            
            if(data.success) {
                showToast('âœ… ä¸‹å•æˆåŠŸï¼åå¨å·²æ¥å•');
                cart = [];
                saveAndUpdate();
                document.getElementById('table-num').value = '';
                toggleCartModal();
            } else {
                alert('âŒ å¤±è´¥: ' + data.error);
            }

        } catch(e) {
            showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        }
    }

    // --- 4. è€æ¿æŸ¥è´¦ ---
    async function openAdmin() {
        const modal = document.getElementById('admin-modal');
        const content = document.getElementById('report-content');
        modal.style.display = 'flex';
        
        try {
            const res = await fetch('/api/report/daily');
            const data = await res.json();

            if(!data || data.length === 0) {
                content.innerHTML = '<p>ä»Šæ—¥æš‚æ— æ•°æ®</p>';
                return;
            }

            let html = '';
            let grandTotal = 0;
            data.forEach(shop => {
                grandTotal += parseFloat(shop.total_revenue);
                html += `
                    <div class="report-item">
                        <div>
                            <strong>ğŸ  ${shop.store_id}å·åº—</strong><br>
                            <span style="color:#666; font-size:0.9rem;">${shop.total_orders} ç¬”è®¢å•</span>
                        </div>
                        <div style="font-size:1.2rem; font-weight:bold; color:var(--primary);">
                            Â¥${parseFloat(shop.total_revenue).toFixed(2)}
                        </div>
                    </div>
                `;
            });
            html += `<div style="margin-top:20px; font-weight:bold;">å…¨åº—æ€»è®¡: Â¥${grandTotal.toFixed(2)}</div>`;
            content.innerHTML = html;

        } catch(e) {
            content.innerHTML = '<p style="color:red">åŠ è½½å¤±è´¥</p>';
        }
    }

    // å¯åŠ¨
    init();

</script>
</body>
</html>